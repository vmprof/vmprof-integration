sudo: required
dist: trusty
language: python
python:
  - "3.5"

addons:
  apt:
    packages:
      - firefox
      - mercurial

install:
  - pip install virtualenv --upgrade
  - pip install setuptools --upgrade
  - echo "virtualenv version ... $(virtualenv --version)"
  - echo "python version ... $(python -V)"
  - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
  - sudo dpkg -i google-chrome*.deb
  - pip install -r requirements.txt
  - pip install --pre vmprof

before_script:
  - export CHROME_BIN=/usr/bin/google-chrome
  - export DISPLAY=:99.0
  - sh -e /etc/init.d/xvfb start
  - sleep 3 # give xvfb some time to start
  # download the chrome driver
  - wget http://chromedriver.storage.googleapis.com/2.22/chromedriver_linux64.zip
  - unzip chromedriver_linux64.zip
  - sudo mv chromedriver /usr/bin
  - git clone git://github.com/vmprof/vmprof-server.git
  - cd vmprof-server
  - pip install -r requirements/testing.txt
  - python manage.py migrate
  - python vmlog/test/data/loggen.py
  - python manage.py loaddata vmlog/test/fixtures.yaml
  - python manage.py runserver -v 3 &
  - sleep 3 # wait for django
  - cd ..

script:
  - py.test testvmprof -v -s

notifications:
  irc:
    channels: "irc.freenode.org#baroque-dev"
    template:
      - "%{repository}@%{branch}: %{message} (%{build_url})"
    use_notice: true
    on_success: always
    on_failure: always

  email:
    on_success: change
    on_failure: change
